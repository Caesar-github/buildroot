From 508d05f1805a6e0f5c5d2ebfb257cdbf175f3ba5 Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Wed, 3 Nov 2021 17:52:51 +0800
Subject: [PATCH 51/60] compositor: Support placing subsurface above or below
 all siblings

By passing itself as sibling in ::place_above or ::place_below.

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 libweston/compositor.c | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/libweston/compositor.c b/libweston/compositor.c
index 04e5c0f..8da0642 100644
--- a/libweston/compositor.c
+++ b/libweston/compositor.c
@@ -4763,7 +4763,12 @@ subsurface_place_above(struct wl_client *client,
 	if (!sub)
 		return;
 
-	sibling = subsurface_sibling_check(sub, surface, "place_above");
+	if (surface == sub->surface)
+		sibling = container_of(sub->parent->subsurface_list.next,
+			struct weston_subsurface, parent_link);
+	else
+		sibling = subsurface_sibling_check(sub, surface, "place_above");
+
 	if (!sibling)
 		return;
 
@@ -4787,7 +4792,12 @@ subsurface_place_below(struct wl_client *client,
 	if (!sub)
 		return;
 
-	sibling = subsurface_sibling_check(sub, surface, "place_below");
+	if (surface == sub->surface)
+		sibling = container_of(sub->parent->subsurface_list.prev,
+			struct weston_subsurface, parent_link);
+	else
+		sibling = subsurface_sibling_check(sub, surface, "place_below");
+
 	if (!sibling)
 		return;
 
-- 
2.20.1

