From 2378a56bc8eaaa82b668378958b914c3c62e479a Mon Sep 17 00:00:00 2001
From: Jeffy Chen <jeffy.chen@rock-chips.com>
Date: Wed, 3 Aug 2022 18:43:32 +0800
Subject: [PATCH 76/76] shell: Fix crash when closing a moving window

By doing a sanity check of shsurf->desktop_surface.

Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
---
 desktop-shell/shell.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/desktop-shell/shell.c b/desktop-shell/shell.c
index c22064745..22cf83643 100644
--- a/desktop-shell/shell.c
+++ b/desktop-shell/shell.c
@@ -1390,7 +1390,7 @@ touch_move_grab_motion(struct weston_touch_grab *grab,
 	int dx = wl_fixed_to_int(grab->touch->grab_x + move->dx);
 	int dy = wl_fixed_to_int(grab->touch->grab_y + move->dy);
 
-	if (!shsurf || !move->active)
+	if (!shsurf || !shsurf->desktop_surface || !move->active)
 		return;
 
 	es = weston_desktop_surface_get_surface(shsurf->desktop_surface);
@@ -1522,7 +1522,7 @@ move_grab_motion(struct weston_pointer_grab *grab,
 	int cx, cy;
 
 	weston_pointer_move(pointer, event);
-	if (!shsurf)
+	if (!shsurf || !shsurf->desktop_surface)
 		return;
 
 	surface = weston_desktop_surface_get_surface(shsurf->desktop_surface);
-- 
2.20.1

